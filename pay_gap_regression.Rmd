---
title: "A Regression Analysis of the Gender Pay Gap \\ (Technical Report)"
author: "Maria-Cristiana Gîrjău"
date: "Revised on 14 October 2019"
output: 
  pdf_document:
    fig_height: 3.5
    fig_width: 6
    toc: TRUE
    number_sections: TRUE
fontsize: 11pt
geometry: margin=1in
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
# Loading necessary packages
library(readr)
library(mosaic)
library(dplyr)
library(ggplot2)
library(forcats)
library(purrr)
library(stringr)
library(kableExtra)
library(GGally)
library(leaps)
library(cowplot)

# Tweaks to adjust code chunk font size
chunk_hook <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- chunk_hook(x, options)
  ifelse(options$size != "normalsize", 
         paste0("\n \\", options$size, "\n\n", x, "\n\n \\normalsize"), x)
})

# Setting default chunk and display options
knitr::opts_chunk$set(
  comment = NA, # remove all hashes from the output
  tidy = FALSE, # display code as typed
  comment = "\t", # tab plain R output
  size = "small", # smaller font for code
  fig.align = "center", # center figures
  warning = F, message = F) # suppress warnings & messages in knitted doc

# B&W ggplot2 theme
theme_set(theme_bw())

# Not using scientific notation
options(scipen = 999)
```

\newpage

# Data Wrangling

## Data Import

Importing both the provided sample and the full original PUMS dataset (merged, pre-wrangled, and filtered appropriately in an .R script). The provided sample will be used for analysis, while the full dataset might come in handy for certain visualizations such as maps, which require more data to be meaningful.

```{r import}
# Sample of 3000 to be wrangled in RMarkdown
ACSSmall <- readr::read_csv("data/raw/acs230_3k.csv")

# Full dataset (already wrangled, see .R script for details)
# ACSBig <- readRDS("data/ACSBig.Rds")
```

## Preparation

Preparing the levels for the factor variables we intend to recode.

A lot of the variables will be heavily collapsed, in order to simplify the selection of a regression model. This has been performed in ways that make the most sense to our question at hand. 

Race has been collapsed into two: races that are commonly viewed to benefit from systemic privilege (white and asian), and races that are underprivileged (all others - black, native american, pacific islander etc.).

Citizenship has been rcollapsed into citizen or not citizen - where one was boorn (e.g. mainland US or overseas terirtories) is an unnecessary level of detail for our analysis.

Married has been collapsed into single and ever married - it is assumed that marriage can take a toll on a woman's career.

Education has been collapsed into no college degree, college degree, and graduate, a question of particular interest to me as a college student.

Military is collapsed into yes part of the military or no.

```{r factors}
# Setting factor levels
sex_levels <- c(M = "1",
                "F" = "2")

# collapsing degree
degree_levels <- c("Agriculture" = "11",
                   "Environmental" = "13",
                   "Architecture" = "14",
                   "Ethnic Studies" = "15",
                   "Media and Journalism" = "19",
                   "Communication" = "20",
                   "Computer Science and IT" = "21",
                   "Cosmetology and Gastronomy" = "22",
                   "Education" = "23",
                   "Engineering" = "24",
                   "Engineering" = "25",
                   "Languages" = "26",
                   "Consumer Sciences" = "29",
                   "Law and Policy" = "32",
                   "English Literature" = "33",
                   "Liberal Arts" = "34",
                   "Library Science" = "35",
                   "Biological Sciences" = "36",
                   "Mathematics and Statistics" = "37",
                   "Military" = "38",
                   "Interdisciplinary" = "40",
                   "Fitness" = "41",
                   "Philosophy" = "48",
                   "Theology" = "49",
                   "Physical Sciences" = "50",
                   "Physical Sciences" = "51",
                   "Psychology" = "52",
                   "Law and Policy" = "53",
                   "Law and Policy" = "54",
                   "Social Sciences" = "55",
                   "Construction" = "56",
                   "Construction" = "57",
                   "Transportation" = "59",
                   "Arts" = "60",
                   "Medicine" = "61",
                   "Business and Finance" = "62",
                   "History" = "64")

employment_levels <- c("Employed working" = "1",
                       "Employed not working" = "2",
                       Unemployed = "3",
                       "Military working" = "4",
                       "Military not working" = "5",
                       "Not in labor force" = "6")

region_levels <- c(Northeast = "1",
                   Midwest = "2",
                   South = "3",
                   West = "4",
                   "Puerto Rico" = "9")

state_levels <- c(AL = "1",
                  AK = "2",
                  AZ = "4",
                  AR = "5",
                  CA = "6",
                  CO = "8",
                  CT = "9",
                  DE = "10",
                  DC = "11",
                  FL = "12",
                  GA = "13",
                  HI = "15",
                  ID = "16",
                  IL = "17",
                  IN = "18",
                  IA = "19",
                  KS = "20",
                  KY = "21",
                  LA = "22",
                  ME = "23",
                  MD = "24",
                  MA = "25",
                  MI = "26",
                  MN = "27",
                  MS = "28",
                  MO = "29",
                  MT = "30",
                  NE = "31",
                  NV = "32",
                  NH = "33",
                  NJ = "34",
                  NM = "35",
                  NY = "36",
                  NC = "37",
                  ND = "38",
                  OH = "39",
                  OK = "40",
                  OR = "41",
                  PA = "42",
                  RI = "44",
                  SC = "45",
                  SD = "46",
                  TN = "47",
                  TX = "48",
                  UT = "49",
                  VT = "50",
                  VA = "51",
                  WA = "53",
                  WV = "54",
                  WI = "55",
                  WY = "56",
                  "Puerto Rico" = "72")

# collapsing industry
industry_levels <- c("Agriculture, Forestry, Fishing and Hunting" = "11",
                     "Mining, Quarrying, and Oil and Gas Extraction" = "21",
                     "Utilities" = "22",
                     "Construction" = "23",
                     "Manufacturing" = "31",
                     "Manufacturing" = "32",
                     "Manufacturing" = "33",
                     "Manufacturing" = "3M",
                     "Wholesale Trade" = "42",
                     "Retail Trade" = "44",
                     "Retail Trade" = "45",
                     "Transportation and Warehousing" = "48",
                     "Transportation and Warehousing" = "49",
                     "Information" = "51",
                     "Finance and Insurance" = "52",
                     "Real Estate and Rental and Leasing" = "53",
                     "Professional, Scientific, and Technical Services" = "54",
                     "Management of Companies and Enterprises" = "55",
                     "Administrative and Support and Waste Management 
                     and Remediation Services" = "56",
                     "Educational Services" = "61",
                     "Health Care and Social Assistance" = "62",
                     "Arts, Entertainment, and Recreation" = "71",
                     "Accommodation and Food Services" = "72",
                     "Other Services (except Public Administration)" = "81",
                     "Public Administration" = "92")
```

## Variable Selection

Selecting the variables of interest (see the Data Dictionary in Appendix A for details), renaming and mutating them appropriately, and filtering based on specific criteria.

```{r variables}
# Wrangling the data
ACSSmall <- ACSSmall %>%
  
  mutate(ADJINC.x = ADJINC.x / 10^6, # adding decimal point to ADJINC
         WAGP = WAGP * ADJINC.x, # adjusting dollar amounts for inflation
         HINCP = HINCP * ADJINC.x) %>% # adjusting dollar amounts for inflation
  
  # Selecting which variables to keep
  select(SEX, AGEP, CIT, RAC1P, MIL, DIS, # general demographics
         NP, MAR, NRC, FER, # family and household
         SCHL, FOD1P, FOD2P, SCIENGP, # educational background
         ESR, WKHP, NAICSP, # employment
         HINCP, WAGP, # income
         REGION.x, ST.x) %>% # location
  
  # Renaming the variables
  rename(sex = SEX,
         age = AGEP,
         citizenship = CIT,
         race = RAC1P,
         military = MIL,
         disabled = DIS,
         people_in_household = NP,
         married = MAR,
         children = NRC,
         gave_birth = FER,
         education = SCHL,
         degree_1 = FOD1P,
         degree_2 = FOD2P,
         stem_degree = SCIENGP,
         employment = ESR,
         hours_per_week = WKHP,
         industry = NAICSP,
         household_income = HINCP,
         wage_income = WAGP,
         region = REGION.x,
         state = ST.x) %>%
  
  # Converting inputs to an appropriate data type
  mutate(sex = as.factor(sex) %>%
           forcats::fct_recode(!!!sex_levels),
         
         employment = as.factor(employment) %>%
           forcats::fct_recode(!!!employment_levels),
         
         region = as.factor(region) %>%
           forcats::fct_recode(!!!region_levels),
         
         state = as.factor(state) %>%
           forcats::fct_recode(!!!state_levels),
         
         # for citizenship, 5 stands for not a citizen
         citizenship = ifelse(citizenship == 5, "N", "Y"),
         
         # for race, 1 stands for White and 6 for Asian
         race = ifelse(race %in% c(1, 6), "privileged", "underprivileged"),
         
         # for military, 4 stands for never enlisted
         military = ifelse(military == 4, "N", "Y"),
         
         # for married, 5 stands for single
         ever_married = ifelse(married == 5, "N", "Y"),
         
         # for education, 22, 23, and 24 stand for graduate degrees
         grad_degree = ifelse(education %in% c(22, 23, 24), "Y", "N"),

         gave_birth = ifelse(gave_birth == 1, "Y", "N"),
         
         stem_degree = ifelse(stem_degree == 1, "Y", "N"),
         
         disabled = ifelse(disabled == 1, "Y", "N"),
         
         # Collapsing industry codes into broad NAICS sectors (only taking the first 
         # two digits of the NAICS code, which represent the broader industry sectors)
         industry = substr(industry, start = 1, stop = 2) %>%
           as.factor() %>%
           forcats::fct_recode(!!!industry_levels),
         
         # Collapsing education codes into broader fields (only taking the first 
         # two digits of each code, which represent the broader field)
         degree_1 = substr(degree_1, start = 1, stop = 2) %>%
           as.factor() %>%
           forcats::fct_recode(!!!degree_levels),
         degree_2 = substr(degree_2, start = 1, stop = 2) %>%
           as.factor() %>%
           forcats::fct_recode(!!!degree_levels),
         # Merging the two degree variables, taking care of NAs and repeated values
         degree = ifelse(is.na(degree_1) | is.na(degree_2),
                         as.character(degree_1),
                         ifelse(as.character(degree_1) == as.character(degree_2),
                                as.character(degree_1),
                                paste(degree_1, degree_2, sep = " and ")))) %>%
  
  # Filtering the individuals to keep
  filter(!(is.na(wage_income)) & wage_income > 0, # salary income is positive
         employment %in% c("Employed working",
                           "Employed not working",
                           "Military working"), # employed and/or working
         age >= 18) %>% # only people over 18
  
  # Removing merged variables and those used for filtering
  select(-employment, -degree_1, -degree_2, -education)  %>%
  
  # Dropping unused factor levels
  mutate_if(is.factor, fct_drop)

saveRDS(ACSSmall, file = "data/ACSSmall.Rds")
```

```{r, remove, include=FALSE}
# Removing unused variables
rm()
```

# Data exploration

In this section, we will be exploring distributions and associations graphically and numerically, as a preparation for our model fitting and in order to better understand our data.

Let's take a look at the variables in our dataset.

```{r categorization}
names(ACSSmall) %>% cat(sep = "\n")
```

Variables to be used for graphical exploration only (because they have many levels): state, industry, degree, region.

Variables to be used for our regression: sex, age (NUMERIC), citizenship, race, military, disabled, married, children (NUMERIC), stem_degree, hours_per_week (NUMERIC), people_in_household (NUMERIC)

## Univariate Data Exploration

In this section we explore univariate distributions of some of the most important demographic variables, especially those that we aim to include in the regression, to see whether we would benefit from any log transformations. The code is trivial and takes up unnecessary space, so it has been deferred to the appendix (see appendix B - Univariate Data Exploration).

### Sex

```{r univariate_sex_1, echo=FALSE}
ACSSmall %>%
  group_by(sex) %>%
  tally() %>%
  kable(booktabs = TRUE, caption = "Distribution of Sex",
        col.names = c("Sex", "Tally")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"))

ggplot(ACSSmall, aes(x = sex, fill= sex)) + 
  geom_bar() + 
  labs(x = "Sex", y = "Count") +
  ggtitle("Distribution of Sex") +
  theme(legend.position = "none") +
  scale_fill_brewer(palette = "Dark2")
```

### Race

```{r univariate_race_1, echo=FALSE}
ACSSmall %>%
  group_by(race) %>%
  tally() %>%
  kable(booktabs = TRUE, caption = "Distribution of Race",
        col.names = c("Race", "Tally")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"))

ggplot(ACSSmall, aes(x = race, fill= race)) + 
  geom_bar() + 
  labs(x = "Race", y = "Count") +
  ggtitle("Distribution of Race") +
  theme(legend.position = "none") +
  scale_fill_brewer(palette = "Dark2")
```

### Income

```{r univariate_income_1, echo=FALSE}
ACSSmall %>%
  favstats(~wage_income, data = .) %>%
  kable(booktabs = TRUE, caption = "Distribution of Wage Income",
        col.names = c("Min", "Q1", "Median", "Q3", "Max", "Mean", "SD", "N", "Missing")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"))

ggplot(ACSSmall, aes(x = wage_income)) + 
  geom_density(fill = "#E6AB02", alpha = 0.6) + 
  labs(x = "Wage Income", y = "Density") +
  ggtitle("Distribution of Wage Income")
```

We notice that the distribution of wage income is strongly skewed right, so it would be wise to consider a $\text{log}_{10}$ transformation.

```{r univariate_log_income_1, echo=FALSE}
ACSSmall <- ACSSmall %>%
  mutate(log_wage_income = log10(wage_income))

ACSSmall %>%
  favstats(~log_wage_income, data = .) %>%
  kable(booktabs = TRUE, caption = "Distribution of Log(Wage Income)",
        col.names = c("Min", "Q1", "Median", "Q3", "Max", "Mean", "SD", "N", "Missing")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"))

ggplot(ACSSmall, aes(x = log_wage_income)) + 
  geom_density(fill = "#E6AB02", alpha = 0.6) + 
  labs(x = "Log(Wage Income)", y = "Density") +
  ggtitle("Distribution of Log(Wage Income)")
```

This looks much better, despite a slight left skew. We shall use ``log_wage_income`` as our response variable, partly because of skewness, but also because income is better considered on a multiplicative rather than additive scale. In other words, \$1,000 is worth a lot more to a poor person than a millionaire because \$1,000 is a much greater fraction of the poor person's wealth.

### Age

```{r univariate_age_1, echo=FALSE}
ACSSmall %>%
  favstats(~age, data = .) %>%
  kable(booktabs = TRUE, caption = "Distribution of Age",
        col.names = c("Min", "Q1", "Median", "Q3", "Max", "Mean", "SD", "N", "Missing")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"))

ggplot(ACSSmall, aes(x = age)) + 
  geom_density(fill = "#E7298A", alpha = 0.6) + 
  labs(x = "Age", y = "Density") +
  ggtitle("Distribution of Age")
```

Understandably, the number of individuals in our sample starts to fall dramatically past the age of 60, since that is usually when the sweet release of death is upon us.

### Region 

```{r univariate_region_1, echo=FALSE}
ACSSmall %>%
  group_by(region) %>%
  tally() %>%
  kable(booktabs = TRUE, caption = "Distribution of Region",
        col.names = c("Region", "Tally")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"))

ggplot(ACSSmall, aes(x = region, fill= region)) + 
  geom_bar() + 
  labs(x = "Region", y = "Count") +
  ggtitle("Distribution of Region") +
  theme(legend.position = "none") +
  scale_fill_brewer(palette = "Dark2")
```

### Marital Status

```{r univariate_married_1, echo=FALSE}
ACSSmall %>%
  group_by(married) %>%
  tally() %>%
  kable(booktabs = TRUE, caption = "Distribution of Marital Status",
        col.names = c("Marital Status", "Tally")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"))

ggplot(ACSSmall, aes(x = married, fill= married)) + 
  geom_bar() + 
  labs(x = "Marital Status", y = "Count") +
  ggtitle("Distribution of Marital Status") +
  theme(legend.position = "none") +
  scale_fill_brewer(palette = "Dark2")
```

## Multivariate Data Exploration

In this section we take a multivariate approach to exploring our data.

# Data Analysis

- add in bivariate explorations - how is income related with all of the variables, especially between men and women (color = sex)?

Regression:
- best subsets selection / forward selection
- interaction terms?
- analysis of the model - is everything linear?
- F-test and z-test
- LOG transformation
- R squared - yes sex is significant, but it doesnt account for much variability, so its not practically significant

```{r regression_variables}
# Creating a dataset to be used for our predictor selection procedure
ACSReg <- ACSSmall %>%
  # selecting the potential predictors...
  select(sex, age, citizenship, race, military, disabled, ever_married, children, 
         stem_degree, people_in_household, hours_per_week, grad_degree,
         # ... and the response
         log_wage_income)
```

```{r}
output <- summary(leaps::regsubsets(log_wage_income ~ ., nbest = 1, data = ACSReg))
subsets <- output$which
R2adj <- round(100 * output$adjr2, 1)
Cp <- round(output$cp, 1)
BIC <- round(output$bic, 1)
cbind(as.data.frame(subsets), R2adj, Cp, BIC) %>%
  # we want the highest adjusted R squared
  arrange(desc(R2adj)) %>% head(n = 5) %>%
  t() %>%
  unlist(use.names = TRUE) %>%
  as.data.frame()
```

Nice!! Would any transformations be of use?

```{r}
ggplot(ACSReg, aes(x = age, y = log_wage_income)) + 
  geom_jitter() +
  geom_smooth(se = FALSE, color = "red")

ggplot(ACSReg, aes(x = people_in_household, y = log_wage_income)) + 
  geom_jitter() +
  geom_smooth(se = FALSE, color = "red")

ggplot(ACSReg, aes(x = hours_per_week, y = log_wage_income)) + 
  geom_jitter() +
  geom_smooth(se = FALSE, color = "red")
```

Age might benefit from a squared transformation:

```{r}
ACSReg <- ACSReg %>%
  mutate(age2 = age^2)
```

```{r}
output <- summary(leaps::regsubsets(log_wage_income ~ ., nbest = 1, data = ACSReg))
subsets <- output$which
R2adj <- round(100 * output$adjr2, 1)
Cp <- round(output$cp, 1)
BIC <- round(output$bic, 1)
cbind(as.data.frame(subsets), R2adj, Cp, BIC) %>%
  # we want the highest adjusted R squared
  arrange(desc(R2adj)) %>% head(n = 5) %>%
  t() %>%
  unlist(use.names = TRUE) %>%
  as.data.frame()
```

This looks promising! Let's try to throw in some potential interaction terms.

```{r}
output <- summary(leaps::regsubsets(log_wage_income ~ . + 
                               race * hours_per_week + 
                               grad_degree * age + 
                               stem_degree * hours_per_week, nbest = 1, data = ACSReg))
subsets <- output$which
R2adj <- round(100 * output$adjr2, 1)
Cp <- round(output$cp, 1)
BIC <- round(output$bic, 1)
cbind(as.data.frame(subsets), R2adj, Cp, BIC) %>%
  # we want the highest adjusted R squared
  arrange(Cp) %>% head(n = 5) %>%
  t() %>%
  unlist(use.names = TRUE) %>%
  as.data.frame()
```

```{r}
bestModel <- lm(log_wage_income ~ age + age2 + sex * hours_per_week + grad_degree,
                data = ACSReg)
msummary(bestModel)
```

## Nested F-test

```{r}
reducedModel <- lm(log_wage_income ~ age + age2 + hours_per_week + grad_degree, data = ACSReg)
anova(reducedModel, bestModel)

reducedModel <- lm(log_wage_income ~ age + age2 + sex + hours_per_week + grad_degree, data = ACSReg)
anova(reducedModel, bestModel)
```

# Assessment

```{r, fig.height=3, fig.width=10}
diagnostic <- function(model, binwidth) {
  
  # Scatterplot of the residuals
  r1 <- ggplot(data = model, aes(x = .fitted, y = .resid)) +
    geom_point(alpha = 0.5) +
    geom_smooth(color = "red", se = FALSE) +
    geom_hline(yintercept = 0, linetype = 2, color = "grey") +
    xlab("Fitted Values") +
    ylab("Residuals") +
    ggtitle("Scatterplot of the Residuals")
  
  # Normal QQ-plot
  r2 <- ggplot(data = model, aes(sample = .resid)) +
    geom_qq(alpha = 0.5) +
    geom_qq_line() +
    xlab("Theoretical Quantiles") +
    ylab("Sample Quantiles") +
    ggtitle("Normal Q-Q Plot")
  
  # Histogram of the residuals
  r3 <- ggplot(data = model, aes(x = .resid, y = ..count..)) +
    geom_histogram(fill = "navy", binwidth = binwidth) +
    xlab("Residual") + 
    ylab("Count") +
    ggtitle("Histogram of the Residuals")
  
  # Plotting all three side by side
  cowplot::plot_grid(plotlist = list(r1, r2, r3), nrow = 1)
}

diagnostic(bestModel, binwidth = NULL)
```

Nice model - we like !!

# Appendices

<!--
Visualizations:
- cluster based on income and other stuff, and observe different proportions of men and women in the clusters
- heatmap of wage difference by industry and by degree
- interactive balloon chart for every industry or degree
- interactive map of wage differences by state and by region

- Z test to see if proportion of household income contributed by men's wages is significantly different than proportion of household income contributed by women's wages -->

## Data Dictionary

A number of variables have been identified as potentially relevant to the issue of the gender pay gap. Optimally, a careful consideration of each of them might provide us with a more precise understanding of the relationship between gender and income. However, only some of the variables below will make it into our final regression models - some will be used for filtering (e.g. \textbf{employment}), others are intended for creating meaningful visualizations (e.g. \textbf{state}, \textbf{industry}), and others might prove to have an insignificant effect on the relationship between gender and income.

In the list below, variables have been grouped under general topics, and we have included their names as they appear in the original data set, their new names as assigned for our analysis, as well as their respective descriptions from the Data Dictionary. For each individual, we will look at:

\begin{enumerate}
    \item General demographics:
    \begin{enumerate}
        \item \textbf{SEX} (renamed to \textbf{sex}) - \textit{``Sex''}
        \item \textbf{AGEP} (renamed to \textbf{age}) - \textit{``Age''}
        \item \textbf{CIT} (renamed to \textbf{citizenship}) - \textit{``Citizenship Status''}
        \item \textbf{RAC1P} (renamed to \textbf{race}) - \textit{``Recoded detailed race code''}
        \item \textbf{MIL} (renamed to \textbf{military}) - \textit{``Military service''}
        \item \textbf{DIS} (renamed to \textbf{disabled}) - \textit{``Disability recode''}
    \end{enumerate}
    \item Family and household:
    \begin{enumerate}
        \item \textbf{MAR} (renamed to \textbf{married})- \textit{``Marital status''}
        \item \textbf{HUPARC} (renamed to \textbf{children\_age}) - \textit{``Household presence and age of related children''}
        \item \textbf{NRC} (renamed to \textbf{children\_no}) - \textit{``Number of related children in household (unweighted)''}
        \item \textbf{FER} - (renamed to \textbf{gave\_birth}) \textit{``Gave birth to child within the past 12 months''}
    \end{enumerate}
        \item Educational background:
    \begin{enumerate}
        \item \textbf{SCHL} (renamed to \textbf{education}) - \textit{``Educational attainment''}
        \item \textbf{FOD1P} (will be merged with \textbf{FOD2P} to create \textbf{degree}) - \textit{``Recoded field of degree - first entry''}
        \item \textbf{FOD2P} (will be merged with \textbf{FOD1P} to create \textbf{degree}) - \textit{``Recoded field of degree - second entry''} \footnote{e.g. for double majors or dual degrees}
        \item \textbf{SCIENGP} - (renamed to \textbf{stem\_degree}) \textit{``Field of Degree Science and Engineering Flag - NSF Definition''}
    \end{enumerate}
    \item Employment:
    \begin{enumerate}
        \item \textbf{ESR} (renamed to \textbf{employment}) - \textit{``Employment status recode''}
        \item \textbf{COW} (renamed to \textbf{worker\_class}) - \textit{``Class of worker''}
        \item \textbf{WKHP} (renamed to \textbf{hours\_worked}) - \textit{``Usual hours worked per week past 12 months'}
        \item \textbf{WKW} (renamed to \textbf{weeks\_worked}) - \textit{``Weeks worked during past 12 months''}
        \item \textbf{NAICSP} (renamed to \textbf{industry}) - \textit{``NAICS Industry recode for 2013 and later based on 2012 NAICS codes''}
    \end{enumerate}
    \item Income:
    \begin{enumerate}
        \item \textbf{WAGP} (renamed to \textbf{wage\_income}) - \textit{``Wages or salary income past 12 months (use ADJINC to adjust WAGP to constant dollars)''}
        \item \textbf{ADJINC} (not renamed, will be used during data wrangling to adjust dollar amounts, then discarded) - \textit{``Adjustment factor for income and earnings dollar amounts''}
    \end{enumerate}
    \item Location:
    \begin{enumerate}
        \item \textbf{REGION} (renamed to \textbf{region}) - \textit{``Region code based on 2010 Census definitions''}
        \item \textbf{ST} (renamed to \textbf{state}) - `\textit{`State Code based on 2010 Census definitions'}
    \end{enumerate}
\end{enumerate}

```{r eval=FALSE}
# How many clusters would we need? Let's make an elbow plot...
tot_withinss <- map_dbl(1:10,  function(k) {
  model <- kmeans(ACSBig %>% select(wage_income, age, children_no) %>% na.omit(), centers = k)
  model$tot.withinss
})

elbow_df <- data.frame(
  k = 1:10,
  tot_withinss = tot_withinss
)

ggplot(elbow_df, aes(x = k, y = tot_withinss)) +
  geom_line() +
  scale_x_continuous(breaks = 1:10)

clusters <- ACSBig %>%
  select(wage_income, age, children_no) %>%
  na.omit() %>%
  kmeans(centers = 3) %>%
  fitted("classes") %>%
  as.factor()

ACSBigClustered <- ACSBig %>%
  select(wage_income, age, children_no, sex) %>%
  na.omit() %>%
  mutate(cluster = clusters)

ggpairs(ACSBigClustered %>% select(wage_income, sex, cluster), mapping = aes(color = cluster))

ggplot(ACSBigClustered, aes(x = sex, fill = cluster)) +
  geom_bar()

prop.table(table(ACSBigClustered$sex, ACSBigClustered$cluster), margin = 2) * 100
```

## Another Appendix (B)

The code from the Univariate Data Exploration section appears here.

```{r univariate2, ref.label='univariate1', echo=TRUE, results='markup', eval=FALSE}

```
