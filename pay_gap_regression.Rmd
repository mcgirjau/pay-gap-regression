---
title: "A Regression Analysis of the Gender Pay Gap \\ (Technical Report)"
author: "Maria-Cristiana Gîrjău"
date: "Revised on 14 October 2019"
output: 
  pdf_document:
    fig_height: 4
    fig_width: 6
    toc: TRUE
    number_sections: TRUE
fontsize: 11pt
geometry: margin=1in
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
# Loading necessary packages
require(readr)
require(mosaic)
require(dplyr)
require(ggplot2)
require(forcats)
require(stringr)
require(purrr)
require(kableExtra)
require(data.table)

# Tweaks to adjust code chunk font size
chunk_hook <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- chunk_hook(x, options)
  ifelse(options$size != "normalsize", 
         paste0("\n \\", options$size, "\n\n", x, "\n\n \\normalsize"), x)
})

# Setting default chunk and display options
knitr::opts_chunk$set(
  tidy = FALSE, # display code as typed
  comment = "\t", # tab plain R output
  size = "small", # smaller font for code
  fig.align = "center", # center figures
  warning = F, message = F) # suppress warnings & messages in knitted doc

# B&w ggplot2 theme
theme_set(theme_bw())

# Not using scientific notation
options(scipen = 999)
```

\newpage

# Data Wrangling

## Data Import

Importing both the provided sample and the full original PUMS dataset (merged, pre-wrangled, and filtered appropriately in an .R script). The provided sample will be used for analysis, while the full dataset might come in handy for certain visualizations such as maps, which require more data to be meaningful.

```{r import}
# Sample of 3000 to be wrangled in RMarkdown
ACSSampleRaw <- readr::read_csv("data/acs230_3k.csv")

# Full dataset (already wrangled, see .R script for details)
ACS <- readRDS("data/ACS.Rds")
```

## Preparation

Preparing the levels for the factor variables we intend to recode.

```{r factors}
# Setting factor levels
sex_levels <- c(M = "1",
                "F" = "2")

citizenship_levels <- c("US born" = "1",
                        "territories born" = "2",
                        "aborad born" = "3",
                        naturalized = "4",
                        "not a citizen" = "5")

race_levels <- c(white = "1",
                  black = "2",
                  native = "3",
                  native = "4",
                  native = "5",
                  asian = "6",
                  native = "7",
                  other = "8",
                  multiple = "9")

military_levels <- c(active = "1",
                     past = "2",
                     training = "3",
                     never = "4")

married_levels <- c(married = "1",
                    widowed = "2",
                    divorced = "3",
                    separated = "4",
                    single = "5")

children_age_levels <- c("under six" = "1",
                         "above six" = "2",
                         both = "3",
                         none = "4")

education_levels <- c(none = "1",
                      preschool = "2",
                      kindergarten = "3",
                      "grade school" = "4",
                      "grade school" = "5",
                      "grade school" = "6",
                      "grade school" = "7",
                      "grade school" = "8",
                      "grade school" = "9",
                      "grade school" = "10",
                      "grade school" = "11",
                      "some high school" = "12",
                      "some high school" = "13",
                      "some high school" = "14",
                      "some high school" = "15",
                      "high school diploma" = "16",
                      "high school diploma" = "17",
                      "less than one year of college" = "18",
                      "more than one year of college" = "19",
                      "associate degree" = "20",
                      "bachelor's degree" = "21",
                      "master's degree" = "22",
                      "professional degree" = "23",
                      "doctoral degree" = "24")

degree_levels <- c("Agriculture" = "11",
                   "Environmental" = "13",
                   "Architecture" = "14",
                   "Ethnic Studies" = "15",
                   "Media and Journalism" = "19",
                   "Communication" = "20",
                   "Computer Science and IT" = "21",
                   "Cosmetology and Gastronomy" = "22",
                   "Education" = "23",
                   "Engineering" = "24",
                   "Engineering" = "25",
                   "Languages" = "26",
                   "Consumer Sciences" = "29",
                   "Law and Policy" = "32",
                   "English Literature" = "33",
                   "Liberal Arts" = "34",
                   "Library Science" = "35",
                   "Biological Sciences" = "36",
                   "Mathematics and Statistics" = "37",
                   "Military" = "38",
                   "Interdisciplinary" = "40",
                   "Fitness" = "41",
                   "Philosophy" = "48",
                   "Theology" = "49",
                   "Physical Sciences" = "50",
                   "Physical Sciences" = "51",
                   "Psychology" = "52",
                   "Law and Policy" = "53",
                   "Law and Policy" = "54",
                   "Social Sciences" = "55",
                   "Construction" = "56",
                   "Construction" = "57",
                   "Transportation" = "59",
                   "Arts" = "60",
                   "Medicine" = "61",
                   "Business and Finance" = "62",
                   "History" = "64")

employment_levels <- c("employed working" = "1",
                       "employed not working" = "2",
                       unemployed = "3",
                       "military working" = "4",
                       "military not working" = "5",
                       "not in labor force" = "6")

worker_class_levels <- c("Private for-profit" = 1,
                         "Private not-for-profit" = 2,
                         "Local government" = 3,
                         "State government" = 4,
                         "Federal government" = 5,
                         "Self-employed" = 6,
                         "Self-employed" = 7,
                         "Family business" = 8,
                         "Never worked" = 9)

region_levels <- c(Northeast = "1",
                   Midwest = "2",
                   South = "3",
                   West = "4",
                   "Puerto Rico" = "9")

state_levels <- c(AL = "1",
                  AK = "2",
                  AZ = "4",
                  AR = "5",
                  CA = "6",
                  CO = "8",
                  CT = "9",
                  DE = "10",
                  DC = "11",
                  FL = "12",
                  GA = "13",
                  HI = "15",
                  ID = "16",
                  IL = "17",
                  IN = "18",
                  IA = "19",
                  KS = "20",
                  KY = "21",
                  LA = "22",
                  ME = "23",
                  MD = "24",
                  MA = "25",
                  MI = "26",
                  MN = "27",
                  MS = "28",
                  MO = "29",
                  MT = "30",
                  NE = "31",
                  NV = "32",
                  NH = "33",
                  NJ = "34",
                  NM = "35",
                  NY = "36",
                  NC = "37",
                  ND = "38",
                  OH = "39",
                  OK = "40",
                  OR = "41",
                  PA = "42",
                  RI = "44",
                  SC = "45",
                  SD = "46",
                  TN = "47",
                  TX = "48",
                  UT = "49",
                  VT = "50",
                  VA = "51",
                  WA = "53",
                  WV = "54",
                  WI = "55",
                  WY = "56",
                  "Puerto Rico" = "72")

industry_levels <- c("Agriculture, Forestry, Fishing and Hunting" = "11",
                     "Mining, Quarrying, and Oil and Gas Extraction" = "21",
                     "Utilities" = "22",
                     "Construction" = "23",
                     "Manufacturing" = "31",
                     "Manufacturing" = "32",
                     "Manufacturing" = "33",
                     "Manufacturing" = "3M",
                     "Wholesale Trade" = "42",
                     "Retail Trade" = "44",
                     "Retail Trade" = "45",
                     "Transportation and Warehousing" = "48",
                     "Transportation and Warehousing" = "49",
                     "Information" = "51",
                     "Finance and Insurance" = "52",
                     "Real Estate and Rental and Leasing" = "53",
                     "Professional, Scientific, and Technical Services" = "54",
                     "Management of Companies and Enterprises" = "55",
                     "Administrative and Support and Waste Management 
                     and Remediation Services" = "56",
                     "Educational Services" = "61",
                     "Health Care and Social Assistance" = "62",
                     "Arts, Entertainment, and Recreation" = "71",
                     "Accommodation and Food Services" = "72",
                     "Other Services (except Public Administration)" = "81",
                     "Public Administration" = "92")
```

## Variable Selection

Selecting the variables of interest (see the Data Dictionary in the Appendices for details), renaming and mutating them appropriately, and filtering based on specific criteria.

```{r variables}
# Wrangling the data
ACSSample <- ACSSampleRaw %>%
  
  mutate(ADJINC.x = ADJINC.x / 10^6, # adding decimal point to ADJINC
         WAGP = WAGP * ADJINC.x) %>% # adjusting dollar amounts for inflation
  
  # Selecting which variables to keep
  select(SEX, AGEP, CIT, RAC1P, MIL, DIS, # general demographics
         MAR, HUPARC, NRC, FER, # family and household
         SCHL, FOD1P, FOD2P, SCIENGP, # educational background
         ESR, COW, WKW, WKHP, NAICSP, # employment
         WAGP, # income
         REGION.x, ST.x) %>% # location
  
  # Renaming the variables
  rename(sex = SEX,
         age = AGEP,
         citizenship = CIT,
         race = RAC1P,
         military = MIL,
         disabled = DIS,
         married = MAR,
         children_age = HUPARC,
         children_no = NRC,
         gave_birth = FER,
         education = SCHL,
         degree_1 = FOD1P,
         degree_2 = FOD2P,
         stem_degree = SCIENGP,
         employment = ESR,
         worker_class = COW,
         weeks_worked = WKW,
         hours_worked = WKHP,
         industry = NAICSP,
         wage_income = WAGP,
         region = REGION.x,
         state = ST.x) %>%
  
  # Converting inputs to an appropriate data type
  mutate(sex = as.factor(sex) %>%
           fct_recode(!!!sex_levels),
         
         citizenship = as.factor(citizenship) %>%
           fct_recode(!!!citizenship_levels),
         
         race = as.factor(race) %>%
           fct_recode(!!!race_levels),
         
         military = as.factor(military) %>%
           fct_recode(!!!military_levels),
         
         married = as.factor(married) %>%
           fct_recode(!!!married_levels),
         
         children_age = as.factor(children_age) %>%
           fct_recode(!!!children_age_levels),
         
         education = as.factor(education) %>%
           fct_recode(!!!education_levels),
         
         employment = as.factor(employment) %>%
           fct_recode(!!!employment_levels),
         
         region = as.factor(region) %>%
           fct_recode(!!!region_levels),
         
         state = as.factor(state) %>%
           fct_recode(!!!state_levels),
         
         gave_birth = ifelse(gave_birth == 1, TRUE, FALSE),
         
         stem_degree = ifelse(stem_degree == 1, TRUE, FALSE),
         
         disabled = ifelse(disabled == 1, TRUE, FALSE),
         
         # Collapsing industry codes into broad NAICS sectors (only taking the first 
         # two digits of the NAICS code, which represent the broader industry sectors)
         industry = substr(industry, start = 1, stop = 2) %>%
           as.factor() %>%
           fct_recode(!!!industry_levels),
         
         # Collapsing education codes into broader fields (only taking the first 
         # two digits of each code, which represent the broader field)
         degree_1 = substr(degree_1, start = 1, stop = 2) %>%
           as.factor() %>%
           fct_recode(!!!degree_levels),
         degree_2 = substr(degree_2, start = 1, stop = 2) %>%
           as.factor() %>%
           fct_recode(!!!degree_levels),
         # Merging the two degree variables, taking care of NAs and repeated values
         degree = ifelse(is.na(degree_1) | is.na(degree_2),
                         as.character(degree_1),
                         ifelse(as.character(degree_1) == as.character(degree_2),
                                as.character(degree_1),
                                paste(degree_1, degree_2, sep = " and ")))) %>%
  
  # Filtering the individuals to keep
  filter(!(is.na(wage_income)) & wage_income > 0, # salary income is positive
         employment %in% c("employed working",
                           "employed not working",
                           "military working"), # employed and/or working
         age >= 18) %>% # only people over 18
  
  # Removing merged variables and those used for filtering
  select(-employment, -degree_1, -degree_2)  %>%
  
  # Dropping unused factor levels
  mutate_if(is.factor, fct_drop)

```

```{r, remove, include=FALSE}
# Removing unused variables
rm(children_age_levels, citizenship_levels, degree_levels, 
     disabled_levels, education_levels, employment_levels,
     gave_birth_levels, married_levels, military_levels,
     race_levels, region_levels, sex_levels, state_levels,
     stem_degree_levels, worker_class_levels, industry_levels)

rm(ACSSampleRaw)
```

# Data exploration

Exploring distributions and associations graphically and numerically.

```{r functions}
# Some functions for repetitive tasks
render_table <- function(data, title = NULL) {
  data %>%
    kable(booktabs = TRUE, caption = title) %>%
    kable_styling(latex_options = c("striped", "HOLD_position"))
}
```

## Univariate Data Exploration

```{r univariate}
# Must make graphics nicer - colors, axis labels, titles, captions

# sex
ACSSample %>%
  group_by(sex) %>%
  tally() %>%
  render_table("Distribution of ")

ggplot(ACSSample, aes(x = sex)) + 
  geom_bar()

# race
ACSSample %>%
  group_by(race) %>%
  tally() %>%
  render_table()

ggplot(ACSSample, aes(x = race)) + 
  geom_bar()

# income
ACSSample %>%
  favstats(~wage_income, data = .) %>%
  render_table()

ggplot(ACSSample, aes(x = wage_income, y = ..count..)) + 
  geom_density(adjust = 2.5) +
  scale_x_log10() +
  geom_vline(xintercept = median(ACS$wage_income))

# age
ACSSample %>%
  favstats(~age, data = .) %>%
  render_table()

ggplot(ACSSample, aes(x = age, y = ..count..)) + 
  geom_density(fill = "aquamarine3", adjust = 2)

# region 
ACSSample %>%
  group_by(region) %>%
  tally() %>%
  render_table()

ggplot(ACSSample, aes(x = region)) + 
  geom_bar()

# marital status
ACSSample %>%
  group_by(married) %>%
  tally() %>%
  render_table()

ggplot(ACSSample, aes(x = married)) + 
  geom_bar()
```

## Multivariate Data Exploration

# Data Analysis



# Assessment

# Appendices

## Data Dictionary

A number of variables have been identified as potentially relevant to the issue of the gender pay gap. Optimally, a careful consideration of each of them might provide us with a more precise understanding of the relationship between gender and income. However, only some of the variables below will make it into our final regression models - some will be used for filtering (e.g. \textbf{employment}), others are intended for creating meaningful visualizations (e.g. \textbf{state}, \textbf{industry}), and others might prove to have an insignificant effect on the relationship between gender and income.

In the list below, variables have been grouped under general topics, and we have included their names as they appear in the original data set, their new names as assigned for our analysis, as well as their respective descriptions from the Data Dictionary. For each individual, we will look at:

\begin{enumerate}
    \item General demographics:
    \begin{enumerate}
        \item \textbf{SEX} (renamed to \textbf{sex}) - \textit{``Sex''}
        \item \textbf{AGEP} (renamed to \textbf{age}) - \textit{``Age''}
        \item \textbf{CIT} (renamed to \textbf{citizenship}) - \textit{``Citizenship Status''}
        \item \textbf{RAC1P} (renamed to \textbf{race}) - \textit{``Recoded detailed race code''}
        \item \textbf{MIL} (renamed to \textbf{military}) - \textit{``Military service''}
        \item \textbf{DIS} (renamed to \textbf{disabled}) - \textit{``Disability recode''}
    \end{enumerate}
    \item Family and household:
    \begin{enumerate}
        \item \textbf{MAR} (renamed to \textbf{married})- \textit{``Marital status''}
        \item \textbf{HUPARC} (renamed to \textbf{children\_age}) - \textit{``Household presence and age of related children''}
        \item \textbf{NRC} (renamed to \textbf{children\_no}) - \textit{``Number of related children in household (unweighted)''}
        \item \textbf{FER} - (renamed to \textbf{gave\_birth}) \textit{``Gave birth to child within the past 12 months''}
    \end{enumerate}
        \item Educational background:
    \begin{enumerate}
        \item \textbf{SCHL} (renamed to \textbf{education}) - \textit{``Educational attainment''}
        \item \textbf{FOD1P} (will be merged with \textbf{FOD2P} to create \textbf{degree}) - \textit{``Recoded field of degree - first entry''}
        \item \textbf{FOD2P} (will be merged with \textbf{FOD1P} to create \textbf{degree}) - \textit{``Recoded field of degree - second entry''} \footnote{e.g. for double majors or dual degrees}
        \item \textbf{SCIENGP} - (renamed to \textbf{stem\_degree}) \textit{``Field of Degree Science and Engineering Flag - NSF Definition''}
    \end{enumerate}
    \item Employment:
    \begin{enumerate}
        \item \textbf{ESR} (renamed to \textbf{employment}) - \textit{``Employment status recode''}
        \item \textbf{COW} (renamed to \textbf{worker\_class}) - \textit{``Class of worker''}
        \item \textbf{WKHP} (renamed to \textbf{hours\_worked}) - \textit{``Usual hours worked per week past 12 months'}
        \item \textbf{WKW} (renamed to \textbf{weeks\_worked}) - \textit{``Weeks worked during past 12 months''}
        \item \textbf{NAICSP} (renamed to \textbf{industry}) - \textit{``NAICS Industry recode for 2013 and later based on 2012 NAICS codes''}
    \end{enumerate}
    \item Income:
    \begin{enumerate}
        \item \textbf{WAGP} (renamed to \textbf{wage\_income}) - \textit{``Wages or salary income past 12 months (use ADJINC to adjust WAGP to constant dollars)''}
        \item \textbf{ADJINC} (not renamed, will be used during data wrangling to adjust dollar amounts, then discarded) - \textit{``Adjustment factor for income and earnings dollar amounts''}
    \end{enumerate}
    \item Location:
    \begin{enumerate}
        \item \textbf{REGION} (renamed to \textbf{region}) - \textit{``Region code based on 2010 Census definitions''}
        \item \textbf{ST} (renamed to \textbf{state}) - `\textit{`State Code based on 2010 Census definitions'}
    \end{enumerate}
\end{enumerate}

```{r}

# How many clusters would we need? Let's make an elbow plot...
tot_withinss <- map_dbl(1:10,  function(k) {
  model <- kmeans(ACS %>% select(wage_income, age, children_no) %>% na.omit(), centers = k)
  model$tot.withinss
})

elbow_df <- data.frame(
  k = 1:10,
  tot_withinss = tot_withinss
)

ggplot(elbow_df, aes(x = k, y = tot_withinss)) +
  geom_line() +
  scale_x_continuous(breaks = 1:10)

clusters <- ACS %>%
  select(wage_income, age, children_no) %>%
  na.omit() %>%
  kmeans(centers = 3) %>%
  fitted("classes") %>%
  as.factor()

ACS2 <- ACS %>%
  select(wage_income, age, children_no, sex) %>%
  na.omit() %>%
  mutate(cluster = clusters)

ggpairs(ACS2 %>% select(wage_income, sex, cluster), mapping = aes(color = cluster))

ggplot(ACS2, aes(x = sex, fill = cluster)) +
  geom_bar()

prop.table(table(ACS2$sex, ACS2$cluster), margin = 2) * 100
```
